#!/bin/bash
#
# This script is intended to parse tsip's CSV output logs and spit out an average
# of the log's columns.
#
# You may change the timeframe which is averaged by adjusting the regex in the
# first awk command.

output=/tmp/lincoln_rebuild_output
rebuild_file=/etc/sysconfig/vm/info
rebuild_task=/var/spool/CQ/${1}/status
flashcard_file=/etc/sysconfig/vm/flashcards/flashcard-12

rebuild_progress=`awk '/STATUS/' ${rebuild_task} | cut -d '=' -f2`

echo "Rebuild start!" >> $output

while [ ${rebuild_progress} != "100.00" ]
do
    date >> $output
    awk '/STATUS/' ${rebuild_task} >> $output
    awk '/REBUILD/' ${rebuild_file} >> $output
    awk '/REBUILD/' ${flashcard_file} >> $output
    echo "" >> $output
    rebuild_progress=`awk '/STATUS/' ${rebuild_task} | cut -d '=' -f2`
    sleep 60
done;

exit 0;
